name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run speed-mode smoke test
        run: |
          python motor_sim.py --mode speed --rpm 1500 --duration 0.05 --dt 0.0005 --csv out_speed.csv
          test -f out_speed.csv
          lines=$(wc -l < out_speed.csv)
          echo "CSV lines: $lines"
          [ "$lines" -gt 1 ]

      - name: Run torque-mode smoke test
        run: |
          python motor_sim.py --mode torque --torque 0.1 --duration 0.05 --dt 0.0005 --csv out_torque.csv
          test -f out_torque.csv
          lines=$(wc -l < out_torque.csv)
          echo "CSV lines: $lines"
          [ "$lines" -gt 1 ]
